<div class="file-check">
  <form [formGroup]="formGroup" *ngIf="formGroup">
    <div class="chatbot-subtitle">
      <h4>Téléchargement de la base documentaire</h4>
    </div>
    <div class="file-input">
      <span>Chargez la base documentaire de votre chatbot, nous allons vérifier la conformité de votre fichier (format de fichier Excel .xlsx).
        <br/>Si vous n’avez pas le modèle de référence, vous pouvez le télécharger
        <a target="_blank"
           data-cy="TemplateDownloadButton"
           href="https://firebasestorage.googleapis.com/v0/b/gitbook-28427.appspot.com/o/assets%2F-M0MbNyvjB7hr1guybEn%2F-M1jG3_OcdCVFT8JT7J0%2F-M1jHaBUlqkF8rNMKV06%2FTEMPLATE_CHATBOT.xlsx?alt=media&token=f926397d-7b9c-40f5-ad1a-2f7b21283f90">
          ici.
        </a>
      </span>
      <button mat-flat-button
              color="accent"
              data-cy="UploadFileButton"
              [disabled]="(chatbotService.loading$ | async) || !!fileCtrl.value"
              (click)="uploader.click()">
        <mat-icon *ngIf="!(chatbotService.loading$ | async)">add</mat-icon>
        <mat-spinner *ngIf="chatbotService.loading$ | async"
                     aria-label="Chargement et vérification du fichier"
                     [diameter]="24"></mat-spinner>
        Ajouter un fichier
      </button>
      <input hidden
             type="file"
             data-cy="UploadFileInput"
             #uploader
             (change)="uploadFile($event)"
             [accept]="'.xlsx'"/>
    </div>

    <div class="feedback-wrapper" data-cy="FileWrapper" *ngIf="fileTemplateCheckResume">
      <h3>Base documentaire</h3>
      <div class="file-wrapper" *ngIf="fileCtrl.value">
        <div class="file-header">
          <div class="file-name">
            <mat-icon color="primary"
                      *ngIf="!hasFileErrors()">
              check_circle
            </mat-icon>
            <mat-icon color="accent"
                      *ngIf="hasFileErrors()">
              cancel
            </mat-icon>
            {{ fileCtrl.value.name }}
          </div>
          <div class="file-buttons">
            <button mat-stroked-button
                    color="accent"
                    data-cy="DeleteFileBtn"
                    (click)="resetFile()">
              Supprimer
            </button>
            <button mat-flat-button
                    color="accent"
                    data-cy="UpdateFileBtn"
                    [disabled]="chatbotService.loading$ | async"
                    (click)="uploader.click()">
              Mettre à jour
            </button>
          </div>
        </div>
        <div class="file-status">
            <span class="valid" data-cy="FileValidSpan" *ngIf="!hasFileErrors()">
              Votre fichier est valide.
            </span>
          <span class="error" data-cy="FileErrorSpan" *ngIf="hasFileErrors()">
              Votre fichier contient des erreurs. Veuillez le corriger et le mettre à jour.
            </span>
        </div>
        <div class="feedback-wrapper">
          <mat-divider></mat-divider>
          <div class="content">
            <div class="number" data-cy="FileErrorNumber" [ngClass]="{'error': hasFileErrors()}">
              {{objectKeys(fileTemplateCheckResume.errors).length}}
            </div>
            <div class="message">
              <b>Erreur(s)</b><span class="red">*</span><br/>
              <span *ngIf="!hasFileErrors(); else messageError">
                Votre fichier est conforme aux normes.
              </span>
              <ng-template #messageError>
                Votre fichier contient des erreurs qui l'empêche de fonctionner.
                <a data-cy="ErrorDialog" (click)="openDialog(true, fileTemplateCheckResume.errors)">
                  <b>Visualiser les erreurs</b>
                </a>
              </ng-template>
            </div>
            <a target="_blank"
               *ngIf="hasFileErrors()"
               href="https://fabrique-a-chatbots.gitbook.io/fabrique-a-chatbots/base-documentaire/description"
               class="help-btn">
              <button mat-stroked-button
                      type="button"
                      color="primary">
                <mat-icon>help_outline</mat-icon>
                Aide gitbook
              </button>
            </a>
          </div>
          <mat-divider></mat-divider>
          <div class="content">
            <div class="number" data-cy="FileWarningNumber">
              {{ objectKeys(fileTemplateCheckResume.warnings).length }}
            </div>
            <div class="message">
              <b>Avertissement(s)</b><br/>
              <span *ngIf="!hasFileWarnings(); else messageWarning">
                Votre fichier ne contient pas d'avertissements.
              </span>
              <ng-template #messageWarning>
                Votre fichier contient des avertissements qui ne sont pas bloquants pour la création de votre
                chatbot.
                <a data-cy="WarningDialog" (click)="openDialog(false, fileTemplateCheckResume.warnings)">
                  <b>Visualiser les avertissements</b>
                </a>
              </ng-template>
            </div>
            <a target="_blank"
               *ngIf="hasFileWarnings()"
               class="help-btn"
               href="https://fabrique-a-chatbots.gitbook.io/fabrique-a-chatbots/base-documentaire/description">
              <button mat-flat-button
                      color="accent"
                      class="small">
                <mat-icon>help_outline</mat-icon>
                Aide
              </button>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="chatbot-subtitle">
      <h4>Cadre d'utilisation de votre chatbot</h4>
    </div>
    <p>Vous souhaitez que votre chatbot soit consultable sur :</p>
    <mat-radio-group aria-label="Visibilité du chatbot : internet / intradef"
                     labelPosition="before"
                     formControlName="intraDef"
                     color="primary">
      <mat-radio-button data-cy="InternetRadioBtn" [value]="false">Internet</mat-radio-button>
      <mat-radio-button data-cy="IntradefRadioBtn" [value]="true">Intradef</mat-radio-button>
    </mat-radio-group>
    <div class="chatbot-subtitle">
      <h4>Utilisateurs de la plateforme ou contacts</h4>
    </div>
    <div class="author-description">
      <span>
        Vous pouvez sautez cette étape et les ajouter plus tard.
      </span>
    </div>
    <div class="author-content">
      <div class="author-content-element">
        <mat-form-field class="full-width-input" appearance="outline">
          <mat-label>Nom, Prénom</mat-label>
          <input matInput
                 data-cy="NameInput"
                 formControlName="author"
                 [placeholder]="'Saisir ...'"/>
          <mat-error *ngIf="controls.author.hasError('required')">
            Vous n'avez pas saisi le nom du contact.
          </mat-error>
        </mat-form-field>
      </div>
      <div class="author-content-element">
        <mat-form-field class="full-width-input" appearance="outline">
          <mat-label>Rôle</mat-label>
          <mat-select formControlName="role" data-cy="RoleSelector">
            <mat-option *ngFor="let role of roles" [value]="role.value">
              {{role.viewValue}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="controls.role.hasError('required')">Vous n'avez pas renseigné le rôle du contact</mat-error>
        </mat-form-field>
      </div>
      <div class="author-content-element">
        <mat-form-field class="full-width-input" appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput
                 data-cy="EmailInput"
                 formControlName="email"
                 [placeholder]="'Saisir ...'"/>
          <mat-error *ngIf="controls.email.hasError('required')">
            Vous n'avez pas saisi le mail du contact.
          </mat-error>
        </mat-form-field>
      </div>
    </div>
  </form>
</div>
