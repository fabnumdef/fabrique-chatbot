---

# Prerequisites: SSH access for user with password

- hosts: all

  remote_user: log_user

  vars:
    - ansible_user: "log_user"
    - ansible_password: "{{ USER_PASSWORD }}"
    - ansible_become_pass: "{{ USER_PASSWORD }}"
    # BEATS
    - beats_version: 7.10.1
    - beat: packetbeat
    - beat_conf:
        logging.to_files: true
        packetbeat:
          interfaces.device: any
          interfaces.internal_networks:
            - private
          flows:
            timeout: 30s
            period: 30s
          protocols:
            - type: icmp
#            - type: amqp
#              ports: [ 5672 ]
#            - type: cassandra
#              ports: [ 9042 ]
#            - type: dhcpv4
#              ports: [ 67, 68 ]
            - type: dns
              ports: [ 53 ]
              include_authorities: true
              include_additionals: true
            - type: http
              ports: [ 80, 8080, 8000, 5000, 8002, 5601 ]
            - type: memcache
              ports: [ 11211 ]
#            - type: mysql
#              ports: [ 3306,3307 ]
            - type: pgsql
              ports: [ 5432 ]
            - type: redis
              ports: [ 6379 ]
#            - type: thrift
#              ports: [ 9090 ]
#            - type: mongodb
#              ports: [ 27017 ]
#            - type: nfs
#              ports: [ 2049 ]
            - type: tls
              ports:
                - 443   # HTTPS
                - 993   # IMAPS
                - 995   # POP3S
                - 5223  # XMPP over SSL
                - 8443
                - 8883  # Secure MQTT
                - 9243  # Elasticsearch
            - type: sip
              ports: [ 5060 ]
              parse_authorization: true
              parse_body: true
              keep_original: true
          procs.enabled: false
          ignore_outgoing: false
    - output_conf: {"logstash":{"hosts":["127.0.0.1:5044"]}}

  roles:
    - role: elastic.beats
