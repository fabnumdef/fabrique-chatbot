---

# Prerequisites: SSH access for user with password

- hosts: all

  remote_user: chatbot_user

  vars_files:
    - ./credentials.yml

  vars:
    - ansible_user: "chatbot_user"
    - ansible_password: "{{ USER_PASSWORD }}"
    - ansible_become_pass: "{{ USER_PASSWORD }}"

  tasks:

    - name: Do not allow root access via ssh
      become: yes
      lineinfile:
        line: PermitRootLogin no
        dest: /etc/ssh/sshd_config
        regexp: ^PermitRootLogin
      notify:
        - restart ssh - Debian
        - restart ssh - CentOS

    - name: Delete ssh host keys
      become: yes
      shell: "rm /etc/ssh/ssh_host_* && dpkg-reconfigure openssh-server"
      notify: restart ssh
      when: renew_ssh is defined and renew_ssh == "yes"

    - name: Make sure ufw is installed - Debian
      become: yes
      apt:
        name: ufw
      when: ansible_distribution == 'Debian'

    - name: Make sure epel-release is installed - CentOS
      become: yes
      yum:
        name: epel-release
      when: ansible_distribution == 'CentOS'

    - name: Make sure ufw is installed - CentOS
      become: yes
      yum:
        name: ufw
      when: ansible_distribution == 'CentOS'

    - name: Configure firewall
      become: yes
      ufw:
        policy: deny
        state: enabled

    - name: Open port ssh
      become: yes
      ufw:
        rule: limit
        port: ssh
        proto: tcp

    - name: Open port 443
      become: yes
      ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: Open port 80
      become: yes
      ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: Open port 5005
      become: yes
      ufw:
        rule: allow
        port: '5005'
        proto: tcp

  handlers:

    - name: restart ssh
      become: yes
      service:
        name: ssh
        state: restarted
      when: ansible_distribution == 'Debian'

    - name: restart ssh
      become: yes
      systemd:
        name: ssh
        state: restarted
      when: ansible_distribution == 'CentOS'
