---

# Prerequisite:
#   ssh access with root and password
#   ssh authentication key on local machine

- hosts: all
  vars_files:
    - ./credentials.yml

  vars:
    - ssh_key: "~/.ssh/id_rsa.pub"
    - ansible_user: "root"
    - ansible_password: "{{ ROOT_PASSWORD }}"

  remote_user: root

  tasks:

    - name: ensure sudo is installed
      become: true
      apt:
        name: sudo

    - name: ensure user is present
      become: true
      user:
        name: chatbot_user
        append: yes
        groups: sudo, root, www-data
        password: "{{ USER_PASSWORD | password_hash('sha512') }}"

    - name: ensure user is accessable with ssh key
      become: true
      authorized_key:
        user: chatbot_user
        key: "{{ lookup('file', '{{ ssh_key }}') }}"
